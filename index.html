<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>생활비 캘린더 앱 (연간)</title>
    <style>
        .hidden { display: none !important; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
        .app-container { max-width: 1400px; margin: 50px auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .app-header { display: flex; justify-content: space-between; align-items: center; }
        #btn-logout { background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; }
        #btn-logout:hover { background: #5a6268; }
        .main-layout { display: flex; gap: 20px; align-items: flex-start; }
        .main-content { flex: 1; overflow: hidden; }
        h1, h2 { text-align: center; margin-bottom: 20px; }
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .tabs button { padding: 8px 16px; border: none; background: #f0f0f0; cursor: pointer; border-radius: 20px; font-weight: 500; transition: background .3s; white-space: nowrap; }
        .tabs button.active { background: linear-gradient(135deg,#00C9FF 0%,#92FE9D 100%); color: #fff; }
        #main-swipe-wrapper { display: flex; width: 300%; transition: transform 0.4s ease-in-out; }
        .main-tab-panel { flex: 0 0 33.333%; box-sizing: border-box; }
        #swipe-container { display: flex; width: 200%; transition: transform 0.4s ease; }
        .step { flex: 0 0 50%; box-sizing: border-box; padding: 0 20px; }
        .year-group { display: flex; justify-content: center; align-items: center; margin: 0 auto 20px; position: relative; }
        .year-group label { margin-right: 16px; font-weight: bold; }
        .year-btn { width: 200px; padding: 8px 12px; text-align: left; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); white-space: nowrap; }
        .year-btn::after { content: "▾"; float: right; color: #666; }
        .year-list { position: absolute; top: calc(100% + 4px); left: calc(50% - 100px); width: 200px; max-height: 160px; border: 1px solid #ccc; border-radius: 6px; background: #fff; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; z-index: 10; }
        .year-list li { list-style: none; padding: 8px 12px; cursor: pointer; }
        .year-list li:hover { background: #f0f0f0; }
        .year-list li.selected { background: #e0e0e0; }
        .sub-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .sub-tabs button { padding: 6px 12px; border: none; background: #e0e0e0; cursor: pointer; border-radius: 12px; transition: background .3s; }
        .sub-tabs button.active { background: #007BFF; color: #fff; }
        .budget-group { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .budget-group label { width: 40px; text-align: right; line-height: 28px; }
        .budget-group input { width: 100px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
        .form-back { display: flex; justify-content: space-between; margin-top: 20px; }
        #back-year, #generate { padding: 8px 20px; border: none; border-radius: 20px; font-size: 14px; cursor: pointer; }
        #back-year { background: #ccc; color: #333; }
        #generate { background: linear-gradient(135deg,#6B73FF 0%,#000DFF 100%); color: #fff; }
        .period-group { display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 15px; }
        .period-group label { font-weight: bold; }
        .period-group select { padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
        .equal-group-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 10px; }
        .equal-group-container label { font-weight: bold; }
        .equal-group-container input { width: 120px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
        #distribute { padding: 8px 16px; background: #28a745; color: #fff; border: none; border-radius: 12px; cursor: pointer; }
        #distribute:hover { background: #218838; }
        #equal-results { max-width: 600px; margin: 10px auto; }

        .calendar-wrapper {
            position: relative;
        }
        .calendar-container { }
        .calendar-pane {
            width: 100%;
            box-sizing: border-box;
            transition: opacity 0.25s ease-out;
        }
        
        #calendar-header {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            height: 36px;
        }
        #calendar-header h2 {
            margin: 0;
            font-size: 24px;
        }
        .calendar-nav {
            position: absolute;
            top: 0;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 36px;
            height: 36px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 50%;
            color: #333;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s, border-color 0.2s;
            flex-shrink: 0;
            z-index: 5;
        }
        #calendar-header #prev-month { left: 0; }
        #calendar-header #next-month { right: 0; }
        .calendar-nav:hover { background-color: #007BFF; color: #fff; border-color: #007BFF; box-shadow: 0 2px 5px rgba(0, 123, 255, 0.3); }
        .calendar-nav:active { background-color: #0056b3; border-color: #0056b3; box-shadow: none; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day-name { font-weight: bold; text-align: center; padding-bottom: 5px; border-bottom: 2px solid #f0f0f0; }
        .day-cell { border: 1px solid #e0e0e0; border-radius: 6px; min-height: 120px; padding: 8px; font-size: 12px; background: #fafafa; }
        .day-cell.empty { background: #f5f5f5; }
        .day-cell.saturday .day-number { color: #007BFF; }
        .day-cell.sunday .day-number { color: #dc3545; }
        .day-number { font-size: 14px; font-weight: bold; margin-bottom: 5px; }
        .day-details p { margin: 4px 0; display: flex; justify-content: space-between; align-items: center; }
        .day-details label { font-weight: 500; white-space: nowrap; flex-shrink: 0; margin-right: 5px; }
        .day-details .amount { font-weight: bold; }
        .day-details .saved { color: #28a745; }
        .day-details .over { color: #dc3545; }
        .day-details input { width: 75px; padding: 2px; border: 1px solid #ccc; border-radius: 3px; text-align: right;}
        .monthly-summary-panel { flex-basis: 0; flex-shrink: 0; padding: 20px 0; border-left: 0px solid #f0f0f0; background-color: #fdfdfd; align-self: stretch; opacity: 0; visibility: hidden; overflow: hidden; transition: flex-basis 0.4s ease-in-out, opacity 0.2s ease-in-out, visibility 0.4s, padding 0.4s ease-in-out; }
        .monthly-summary-panel.visible { flex-basis: 280px; padding: 20px; opacity: 1; visibility: visible; border-left: 1px solid #f0f0f0; }
        #monthly-summary-panel h2 { margin-top: 0; font-size: 24px; margin-bottom: 20px; }
        .summary-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; white-space: nowrap; }
        .summary-label { color: #666; }
        .summary-value { font-weight: bold; font-size: 16px; }
        .summary-value.positive { color: #28a745; }
        .summary-value.negative { color: #dc3545; }
        #year-mismatch-notice { background-color: #f9ecec; border: 1px solid #f5c6cb; color: #b71c1c; border-radius: 8px; padding: 15px; margin-bottom: 15px; text-align: center; display: flex; justify-content: center; align-items: center; gap: 15px; }
        #year-mismatch-notice p { margin: 0; font-size: 14px; }
        #btn-set-new-year { background-color: #dc3545; border: none; color: #fff; padding: 6px 12px; border-radius: 5px; font-weight: bold; cursor: pointer; transition: background-color .2s; }
        #btn-set-new-year:hover { background-color: #c82333; }
        
        #auth-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; box-sizing: border-box; }
        .auth-box { width: 100%; max-width: 380px; padding: 40px; background: #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; box-sizing: border-box; }
        .auth-box h2 { margin-top: 0; margin-bottom: 10px; font-size: 24px; color: #333; }
        .auth-box > p { margin-bottom: 10px; color: #666; }
        .auth-message { font-size: 14px; font-weight: bold; min-height: 20px; margin-bottom: 20px; }
        .auth-message.error { color: #dc3545; }
        .auth-message.success { color: #28a745; }
        .auth-box .input-group { margin-bottom: 15px; text-align: left; }
        .auth-box .input-group label { display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; color: #555; }
        .auth-box .input-group label .optional { font-weight: normal; color: #888; font-size: 12px; }
        .auth-box .input-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .auth-btn { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 8px; background: linear-gradient(135deg,#00C9FF 0%,#92FE9D 100%); color: #fff; font-size: 16px; font-weight: bold; cursor: pointer; transition: opacity .3s; }
        .auth-btn:hover { opacity: 0.9; }
        .auth-links { margin-top: 20px; font-size: 14px; }
        .auth-links a { color: #555; text-decoration: none; margin: 0 10px; }
        .auth-links a:hover { text-decoration: underline; }

        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
        }
        #welcome-screen.visible {
            opacity: 1;
            visibility: visible;
        }
        #welcome-message {
            color: #fff;
            font-size: 3em;
            opacity: 0;
        }
        #welcome-screen.visible #welcome-message {
            animation: hello-motion 2s ease-in-out forwards;
        }
        @keyframes hello-motion {
            0% { opacity: 0; transform: translateY(20px); }
            25%, 75% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
    </style>
</head>
<body>
    <div id="welcome-screen">
        <h1 id="welcome-message"></h1>
    </div>

    <div id="auth-container">
        <div id="login-box" class="auth-box">
            <h2>생활비 캘린더</h2>
            <p>로그인하여 내 가계부를 관리해보세요.</p>
            <p id="login-message" class="auth-message"></p>
            <div class="input-group">
                <input type="text" id="login-id" placeholder="아이디" required>
            </div>
            <div class="input-group">
                <input type="password" id="login-password" placeholder="비밀번호" required>
            </div>
            <button id="btn-login" class="auth-btn">로그인</button>
            <div class="auth-links">
                <a href="#" id="link-to-register">회원가입</a>
                <a href="#" id="link-to-forgot">아이디/비밀번호 찾기</a>
            </div>
        </div>
        <div id="register-box" class="auth-box hidden">
            <h2>회원가입</h2>
            <p>가입하여 지출 관리를 시작하세요.</p>
            <p id="register-message" class="auth-message"></p>
            <div class="input-group">
                <label for="register-name">이름 (필수)</label>
                <input type="text" id="register-name" required>
            </div>
            <div class="input-group">
                <label for="register-id">아이디 (필수)</label>
                <input type="text" id="register-id" required>
            </div>
            <div class="input-group">
                <label for="register-password">비밀번호 (필수)</label>
                <input type="password" id="register-password" required>
            </div>
            <div class="input-group">
                <label for="register-email">이메일 (필수)</label>
                <input type="email" id="register-email" required>
            </div>
            <div class="input-group">
                <label for="register-phone">전화번호 (필수)</label>
                <input type="tel" id="register-phone" required maxlength="13">
            </div>
            <div class="input-group">
                <label for="register-nickname">별명 <span class="optional">(선택)</span></label>
                <input type="text" id="register-nickname">
            </div>
            <button id="btn-register" class="auth-btn">가입하기</button>
            <div class="auth-links">
                <a href="#" id="link-to-login">뒤로가기</a>
            </div>
        </div>
    </div>

    <div class="app-container hidden">
        <div class="main-layout">
            <div class="main-content">
                <div class="app-header">
                    <h1>연간 생활비 캘린더</h1>
                    <button id="btn-logout">로그아웃</button>
                </div>
                <div class="tabs">
                    <button id="tab-btn-budget" class="active">월별 예산</button>
                    <button id="tab-btn-calendar">생활비 달력</button>
                    <button id="tab-btn-summary">요약</button>
                </div>

                <div id="calendar-header" class="hidden">
                    <button id="prev-month" class="calendar-nav">&lt;</button>
                    <h2 id="calendar-title"></h2>
                    <button id="next-month" class="calendar-nav">&gt;</button>
                </div>
                
                <div id="main-swipe-wrapper">
                    <div id="tab-budget" class="main-tab-panel">
                        <div id="swipe-container">
                            <div id="year-step" class="step">
                                <h2>연도 설정</h2>
                                <div class="year-group">
                                    <label>연도</label>
                                    <button class="year-btn" id="year-btn">연도를 선택하세요</button>
                                    <ul class="year-list" id="year-list"></ul>
                                </div>
                            </div>
                            <div id="budget-step" class="step">
                                <h2 id="budget-step-title">월별 예산 설정</h2>
                                <div class="sub-tabs">
                                    <button id="sub-manual" class="active">직접 지정</button>
                                    <button id="sub-equal">균등 분배</button>
                                </div>
                                <div id="equal-group" class="hidden">
                                    <div class="period-group">
                                        <label for="start-month">기간</label> <select id="start-month"></select>
                                        <span>~</span> <select id="end-month"></select>
                                    </div>
                                    <div class="equal-group-container">
                                        <label for="total-budget">총 예산</label> <input type="text" id="total-budget" placeholder="₩ 0">
                                        <button id="distribute">분배 적용</button>
                                    </div>
                                    <div id="equal-results"></div>
                                </div>
                                <div id="manual-group"> <div id="budget-inputs"></div> </div>
                                <div class="form-back">
                                    <button id="back-year">이전</button> <button id="generate">예산 저장</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="tab-calendar" class="main-tab-panel">
                        <div id="calendar-wrapper">
                            <div id="calendar-container">
                                <div class="calendar-pane"></div>
                            </div>
                        </div>
                    </div>
                    <div id="tab-summary" class="main-tab-panel">
                        <div id="summary"></div>
                    </div>
                </div>
            </div>
            <div id="monthly-summary-panel" class="monthly-summary-panel"></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    let authToken = null;
    
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.querySelector('.app-container');
    const loginBox = document.getElementById('login-box');
    const registerBox = document.getElementById('register-box');
    const linkToRegister = document.getElementById('link-to-register');
    const linkToLogin = document.getElementById('link-to-login');
    const loginIdInput = document.getElementById('login-id');
    const loginPasswordInput = document.getElementById('login-password');
    const loginButton = document.getElementById('btn-login');
    const loginMessage = document.getElementById('login-message');
    const registerNameInput = document.getElementById('register-name');
    const registerIdInput = document.getElementById('register-id');
    const registerPasswordInput = document.getElementById('register-password');
    const registerEmailInput = document.getElementById('register-email');
    const registerPhoneInput = document.getElementById('register-phone');
    const registerNicknameInput = document.getElementById('register-nickname');
    const registerButton = document.getElementById('btn-register');
    const registerMessage = document.getElementById('register-message');
    
    const welcomeScreen = document.getElementById('welcome-screen');
    const welcomeMessage = document.getElementById('welcome-message');

    function showMessage(element, message, type = 'error') {
        element.textContent = message;
        element.className = `auth-message ${type}`;
    }

    linkToRegister.addEventListener('click', (e) => {
        e.preventDefault();
        loginBox.classList.add('hidden');
        registerBox.classList.remove('hidden');
        loginMessage.textContent = '';
    });

    linkToLogin.addEventListener('click', (e) => {
        e.preventDefault();
        registerBox.classList.add('hidden');
        loginBox.classList.remove('hidden');
        registerMessage.textContent = '';
    });

    loginButton.addEventListener('click', () => {
        const id = loginIdInput.value.trim();
        const password = loginPasswordInput.value.trim();
        if (!id || !password) {
            showMessage(loginMessage, '아이디와 비밀번호를 모두 입력해주세요.');
            return;
        }
        fetch('https://mybudjet-backend.onrender.com/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, password }),
        })
        .then(response => {
            if (response.ok) { return response.json(); } 
            else { return response.json().then(err => { throw new Error(err.message) }); }
        })
        .then(data => {
            authToken = data.token;
            localStorage.setItem('authToken', data.token);
            localStorage.setItem('userName', data.user.name);
            localStorage.setItem('userNickname', data.user.nickname || '');
            
            showMessage(loginMessage, data.message, 'success');

            setTimeout(() => {
                authContainer.classList.add('hidden');
                
                const displayName = data.user.nickname || data.user.name;
                welcomeMessage.textContent = `${displayName}님 안녕하세요 !`;
                welcomeScreen.classList.add('visible');

                setTimeout(() => {
                    welcomeScreen.classList.remove('visible');
                    appContainer.classList.remove('hidden');
                    initializeMainApp();
                }, 2500);

            }, 500);
        })
        .catch(error => {
            console.error('로그인 요청 실패:', error);
            showMessage(loginMessage, error.message);
        });
    });
    
    registerPhoneInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/[^0-9]/g, '');
            let formattedValue = '';
            if (value.length < 4) { formattedValue = value; } 
            else if (value.length < 8) { formattedValue = value.slice(0, 3) + '-' + value.slice(3); } 
            else { formattedValue = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11); }
            e.target.value = formattedValue;
    });

    registerButton.addEventListener('click', () => {
        const name = registerNameInput.value.trim();
        const id = registerIdInput.value.trim();
        const password = registerPasswordInput.value.trim();
        const email = registerEmailInput.value.trim();
        const phone = registerPhoneInput.value.trim();
        const nickname = registerNicknameInput.value.trim();
        if (!name || !id || !password || !email || !phone) {
            showMessage(registerMessage, '필수 항목을 모두 입력해주세요.');
            return;
        }
        const userData = { id, password, name, email, phone, nickname };
        fetch('https://mybudjet-backend.onrender.com/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(userData),
        })
        .then(response => {
                if (!response.ok) { return response.json().then(err => { throw new Error(err.message) }); }
                return response.json();
        })
        .then(data => {
            showMessage(registerMessage, data.message, 'success');
            setTimeout(() => {
                const inputs = [registerNameInput, registerIdInput, registerPasswordInput, registerEmailInput, registerPhoneInput, registerNicknameInput];
                inputs.forEach(input => input.value = '');
                linkToLogin.click();
            }, 1000);
        })
        .catch(error => {
            console.error('회원가입 요청 실패:', error);
            showMessage(registerMessage, error.message);
        });
    });

    window.allBudgetData = {};
    window.dailyExpenses = {};
    let displayedYear, displayedMonth;
    let isAnimating = false;

    const mainSwipeWrapper = document.getElementById('main-swipe-wrapper');
    const swipeContainer = document.getElementById('swipe-container');
    const yearBtn = document.getElementById('year-btn');
    const yearList = document.getElementById('year-list');
    const current = new Date().getFullYear();
    const monthNames = ['', '1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
    const calendarHeader = document.getElementById('calendar-header');
    const calendarTitle = document.getElementById('calendar-title');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const calendarWrapper = document.getElementById('calendar-wrapper');
    const calendarContainer = document.getElementById('calendar-container');
    const calendarPane = calendarContainer.querySelector('.calendar-pane');
    const summaryPanel = document.getElementById('monthly-summary-panel');
    
    function formatNumber(num) {
            if (typeof num !== 'number') num = 0;
            return '₩ ' + num.toLocaleString();
    }
    function unformatNumber(str) {
            if (typeof str !== 'string') return 0;
            return parseInt(str.replace(/[^0-9-]/g, ''), 10) || 0;
    }
    
    for (let y = current - 10; y <= current + 2; y++) {
        const li = document.createElement('li'); li.textContent = y + '년'; li.dataset.value = y;
        if (y === current) { li.classList.add('selected'); yearBtn.textContent = y + '년'; }
        yearList.appendChild(li);
    }
    yearBtn.addEventListener('click', () => yearList.style.display = yearList.style.display === 'block' ? 'none' : 'block');
    
    async function loadOrClearBudgetsForYear(year) {
        document.getElementById('start-month').value = 1; document.getElementById('end-month').value = 12;
        document.getElementById('total-budget').value = ''; document.getElementById('equal-results').innerHTML = '';
        
        try {
            const res = await fetch(`https://mybudjet-backend.onrender.com/api/budgets/${year}`, { headers: { 'Authorization': `Bearer ${authToken}` } });
            
            // 서버 응답이 성공(2xx)이 아닐 경우 에러 throw
            if (!res.ok) {
                const errorData = await res.json(); // 서버에서 보낸 JSON 에러 메시지를 파싱
                throw new Error(errorData.message || '예산 데이터를 불러오는 중 오류가 발생했습니다.');
            }
            
            const savedBudgets = await res.json();
            window.allBudgetData[year] = savedBudgets;
            for (let m = 1; m <= 12; m++) {
                const budgetInput = document.getElementById(`budget${m}`);
                if (budgetInput) {
                    budgetInput.value = savedBudgets[m] ? formatNumber(savedBudgets[m]) : '';
                }
            }
        } catch (error) {
            console.error("예산 불러오기 실패:", error);
            alert("예산을 불러오는 데 실패했습니다: " + error.message); // 에러 메시지 상세화
        }
    }

    yearList.addEventListener('click', e => {
        if (e.target.tagName === 'LI') {
            const selectedYear = parseInt(e.target.dataset.value);
            const selectedYearText = e.target.textContent;
            yearList.querySelectorAll('li').forEach(li => li.classList.remove('selected'));
            e.target.classList.add('selected');
            yearBtn.textContent = selectedYearText;
            yearList.style.display = 'none';
            document.getElementById('budget-step-title').textContent = `${selectedYearText} 월별 예산 설정`;
            loadOrClearBudgetsForYear(selectedYear);
            swipeContainer.style.transform = 'translateX(-50%)';
        }
    });

    document.getElementById('back-year').addEventListener('click', () => swipeContainer.style.transform = 'translateX(0)');

    const budgetContainer = document.getElementById('budget-inputs');
    for (let m = 1; m <= 12; m++) {
        const div = document.createElement('div');
        div.className = 'budget-group';
        div.innerHTML = `<label for="budget${m